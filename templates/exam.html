<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Học sinh - {{ exam_id }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; background: #f1f5f9; }
        #examForm { display: flex; flex-direction: column; height: 100vh; width: 100%; }
        .header { background: white; padding: 10px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; flex-shrink: 0; }
        .header-info h2 { margin: 0; font-size: 18px; text-transform: uppercase; }
        .main-view { display: flex; flex: 1; overflow: hidden; }
        .pdf-container { flex: 1.2; border-right: 3px solid #cbd5e1; background: #525659; }
        .answer-sheet { flex: 0.8; background: white; overflow-y: auto; padding: 25px; height: 100%; }
        .sec-h { color: #2563eb; border-left: 4px solid #2563eb; padding-left: 12px; margin: 25px 0 15px; font-weight: bold; text-transform: uppercase; }
        .q-g { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .q-i { border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; display: flex; align-items: center; gap: 10px; background: #f8fafc; }
        .q-num-blue { background: #dbeafe; color: #1e40af; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        select, .input-ans { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; outline: none; font-weight: bold; }
        .tf-card { border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: white; }
        .timer { font-size: 24px; font-weight: bold; color: #ef4444; }
        .btn-n { background: #22c55e; color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #cheatOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(153, 27, 27, 0.95); z-index: 9999; color: white; text-align: center; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>
<div id="cheatOverlay">
    <i class="fas fa-exclamation-triangle" style="font-size: 70px; margin-bottom: 20px;"></i>
    <h1>CẢNH BÁO VI PHẠM!</h1>
    <p>Số lần vi phạm: <span id="vC">0/3</span></p>
    <button onclick="document.getElementById('cheatOverlay').style.display='none'" style="padding: 10px 30px; border-radius: 20px; cursor: pointer;">TIẾP TỤC</button>
</div>

<form id="examForm" action="/submit_exam/{{ exam_id }}" method="POST">
    <div class="header">
        <div class="header-info"><h2>Mã đề: {{ exam_id }}</h2></div>
        <div class="timer" id="clock">--:--</div>
        <button type="button" class="btn-n" onclick="if(confirm('Xác nhận nộp bài?')) document.getElementById('examForm').submit()">NỘP BÀI</button>
    </div>

    <div class="main-view">
        <div class="pdf-container"><iframe src="{{ exam.pdf }}#toolbar=0" style="width:100%; height:100%;"></iframe></div>
        <div class="answer-sheet">
            <div class="sec-h">I. TRẮC NGHIỆM (18 CÂU)</div>
            <div class="q-g">
                {% for i in range(1, 19) %}
                <div class="q-i"><div class="q-num-blue">{{ i }}</div>
                    <select name="p1_q{{ i }}"><option value="">-</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
                </div>
                {% endfor %}
            </div>

            <div class="sec-h">II. TRẮC NGHIỆM ĐÚNG SAI (4 CÂU)</div>
            
            {# LOGIC NHẬN DIỆN THÔNG MINH CHO CẢ DỮ LIỆU CŨ LẪN MỚI #}
            {% set p2_type = exam.p2_type %}
            {% if not p2_type %}
                {% if 'Đ' in exam.p2 or 'S' in exam.p2 %} {% set p2_type = 'TF' %} {% else %} {% set p2_type = 'MC' %} {% endif %}
            {% endif %}

            {% if p2_type == "TF" %}
                {% for i in range(1, 5) %}
                <div class="tf-card">
                    <div style="color: #059669; font-weight: bold; margin-bottom: 10px;"><i class="far fa-question-circle"></i> Câu {{ i }}</div>
                    <div style="display:flex; gap:10px; text-align:center;">
                        {% for l in ['A','B','C','D'] %}
                        <div style="flex:1;">
                            <label style="font-size:11px; color:#64748b; font-weight:bold; display:block; margin-bottom:4px;">{{l}}</label>
                            <select name="p2_q{{ i }}_{{ l }}" style="width:100%;">
                                <option value="">-</option><option value="Đ">Đ</option><option value="S">S</option>
                            </select>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="q-g">
                    {% for i in range(1, 5) %}
                    <div class="q-i"><div class="q-num-blue">{{ i }}</div>
                        <select name="p2_q{{ i }}_MC"><option value="">-</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="sec-h">III. TRẢ LỜI NGẮN (6 CÂU)</div>
            <div class="q-g">
                {% for i in range(1, 7) %}
                <div class="q-i"><span style="color:#ea580c; font-weight:bold;">Câu {{ i }}</span>
                    <input type="text" name="p3_q{{ i }}" class="input-ans" placeholder="Nhập đáp án...">
                </div>
                {% endfor %}
            </div>
            <div style="height: 80px;"></div>
        </div>
    </div>
</form>

<script>
    let t = {{ exam.time }} * 60; setInterval(() => {
        let m = Math.floor(t/60), s = t%60;
        document.getElementById('clock').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        if(t > 0) t--; else document.getElementById('examForm').submit();
    }, 1000);
</script>
</body>
</html>